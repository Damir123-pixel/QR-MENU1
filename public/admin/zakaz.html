<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" type="image/png" href="logo.png">
  <title>–ó–∞–∫–∞–∑—ã</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f2f2f2;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
    }
    .order {
      background: #ffffff;
      border-left: 5px solid #3498db;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      transition: all 0.3s ease-in-out;
    }
    .order:hover {
      transform: scale(1.02);
    }
    .order time {
      font-size: 0.9em;
      color: #888;
    }
    .order ul {
      margin: 10px 0 0;
      padding-left: 20px;
    }
    .order li {
      margin-bottom: 5px;
    }
    .clear-button {
      display: block;
      margin: 0 auto 30px auto;
      padding: 12px 24px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .clear-button:hover {
      background-color: #c0392b;
    }

    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: #3498db;
      color: white;
      padding: 10px 18px;
      font-size: 16px;
      font-weight: bold;
      text-decoration: none;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 999;
      transition: background 0.3s ease;
    }
    .back-btn:hover {
      background-color: #2980b9;
    }

    .release-btn {
      margin-top: 15px;
      background: #e74c3c;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .release-btn:hover {
      background: #c0392b;
    }
  </style>
</head>
<body>
  <a href="javascript:history.back()" class="back-btn">‚Üê –ù–∞–∑–∞–¥</a>

  <h1>–í—Å–µ –∑–∞–∫–∞–∑—ã</h1>
  <button class="clear-button" id="clear-orders">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã</button>
  <div id="orders"></div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    onValue,
    remove,
    get,
    child
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCClVQXq8Y5lk2mDHznmvojt9JnLUp6yeQ",
    authDomain: "qr-menu-c4ae0.firebaseapp.com",
    projectId: "qr-menu-c4ae0",
    storageBucket: "qr-menu-c4ae0.appspot.com",
    messagingSenderId: "474351769143",
    appId: "1:474351769143:web:a9e192499f96dc0e4011b2",
    databaseURL: "https://qr-menu-c4ae0-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const ordersRef = ref(db, 'orders');
  const container = document.getElementById('orders');

  // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤
  document.getElementById('clear-orders').addEventListener('click', async () => {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã?")) {
      await remove(ordersRef);
      await remove(ref(db, 'occupiedSeats'));
      alert("–í—Å–µ –∑–∞–∫–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã.");
      location.reload();
    }
  });

  // ‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —Å—Ç–∞—Ä—à–µ 4 —á–∞—Å–æ–≤
  onValue(ordersRef, (snapshot) => {
    let previousOrderIds = new Set();
    container.innerHTML = '';
    const orders = snapshot.val();
    if (!orders) {
      container.innerHTML = '<p style="text-align:center; color:#777">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>';
      return;
    }

    const FOUR_HOURS = 4 * 60 * 60 * 1000;
    const now = Date.now();

    const newOrderIds = new Set(Object.keys(orders));
const hasNewOrder = [...newOrderIds].some(id => !previousOrderIds.has(id));

if (hasNewOrder) {
  const sound = document.getElementById("notificationSound");
  if (sound) sound.play();
}

previousOrderIds = newOrderIds;


    Object.entries(orders).forEach(async ([id, order]) => {
      if (order.seatNumber && order.createdAt && (now - order.createdAt > FOUR_HOURS)) {
        await remove(ref(db, `occupiedSeats/${order.seatNumber}`));
        await remove(ref(db, `orders/${id}`));
        console.log(`–£–¥–∞–ª–µ–Ω –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑ ID ${id}`);
        return; // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ–Ω–¥–µ—Ä —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ
      }

      // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è
      const div = document.createElement('div');
      div.className = 'order';

      const time = order.createdAt
        ? new Date(order.createdAt).toLocaleString()
        : '(–≤—Ä–µ–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ)';

      div.innerHTML = `<time>${time}</time>`;

      if ('tableNumber' in order && 'seatNumber' in order) {
        div.innerHTML += `<p><strong>–°—Ç–æ–ª–∏–∫ ‚Ññ:</strong> ${order.tableNumber} ‚Äî –ú–µ—Å—Ç–æ ‚Ññ${order.seatNumber}</p>`;
      } else if ('tableNumber' in order) {
        div.innerHTML += `<p><strong>–°—Ç–æ–ª–∏–∫ ‚Ññ:</strong> ${order.tableNumber}</p>`;
      } else {
        div.innerHTML += `<p style="color:red; font-weight:bold;">‚ùå –°—Ç–æ–ª–∏–∫ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –∑–∞–∫–∞–∑ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</p>`;
      }

      if (order.payment) {
  if (order.payment === "cash") {
    div.innerHTML += `<p><strong>–û–ø–ª–∞—Ç–∞:</strong> üíµ –ù–∞–ª–∏—á–Ω—ã–µ</p>`;
  } else if (order.payment === "card") {
    div.innerHTML += `<p><strong>–û–ø–ª–∞—Ç–∞:</strong> üí≥ –ö–∞—Ä—Ç–∞</p>`;
  } else {
    div.innerHTML += `<p><strong>–û–ø–ª–∞—Ç–∞:</strong> ‚ùì –ù–µ —É–∫–∞–∑–∞–Ω–æ</p>`;
  }
}


      if (order.items && Array.isArray(order.items)) {
        div.innerHTML += '<h3>–ë–ª—é–¥–∞:</h3><ul>';
        order.items.forEach(i => {
       const quantity = i.qty || 1;
       const itemTotal = i.price * quantity;
       div.innerHTML += `<li>${i.name} √ó ${quantity} ‚Äî ‚Ç∏ ${itemTotal}</li>`;
      });

        div.innerHTML += '</ul>';
      } else {
        div.innerHTML += '<p><em>–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–ª—é–¥–∞—Ö</em></p>';
      }

      if (order.promos && Array.isArray(order.promos) && order.promos.length > 0) {
        div.innerHTML += `<p><strong>–ê–∫—Ü–∏–∏:</strong> ${order.promos.join(', ')}</p>`;
      }

      // –ö–Ω–æ–ø–∫–∞ "–û—Å–≤–æ–±–æ–¥–∏—Ç—å"
      div.innerHTML += `
        <button class="release-btn" onclick="releaseSeat('${id}')">–û—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ</button>
      `;

      container.appendChild(div);
    });
  });

  // –§—É–Ω–∫—Ü–∏—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞ –≤—Ä—É—á–Ω—É—é
  window.releaseSeat = async function(orderId) {
    const dbRef = ref(db);
    try {
      const snapshot = await get(child(dbRef, `orders/${orderId}`));
      if (!snapshot.exists()) {
        alert("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        return;
      }

      const order = snapshot.val();

      if (order?.seatNumber) {
        await remove(ref(db, `occupiedSeats/${order.seatNumber}`));
      }

      await remove(ref(db, `orders/${orderId}`));
      alert("–ú–µ—Å—Ç–æ –∏ –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.");
      location.reload();
    } catch (err) {
      alert("–û—à–∏–±–∫–∞: " + err.message);
    }
  };
</script>

<script>
  import { signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

onAuthStateChanged(auth, (user) => {
  if (!user) {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî —Å—Ä–∞–∑—É –Ω–∞ login.html
    window.location.href = "login.html";
  } else {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏
    const loginTime = localStorage.getItem('loginTime');
    const now = Date.now();

    if (!loginTime) {
      // –ï—Å–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ—Ç ‚Äî –∑–∞–ø–∏—à–µ–º —Ç–µ–∫—É—â–µ–µ
      localStorage.setItem('loginTime', now);
    } else {
      const elapsed = now - parseInt(loginTime, 10);
      const sevenHours = 7 * 60 * 60 * 1000; // 7 —á–∞—Å–æ–≤ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö

      if (elapsed > sevenHours) {
        // –í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ –≤—ã—à–ª–æ ‚Äî –¥–µ–ª–∞–µ–º –≤—ã—Ö–æ–¥ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç
        signOut(auth).then(() => {
          localStorage.removeItem('loginTime'); // –æ—á–∏—Å—Ç–∏–º –≤—Ä–µ–º—è
          window.location.href = "login.html";
        });
      }
    }
  }
});



</script>

<audio id="notificationSound" src="Ring.mp3" preload="auto"></audio>


</body>
</html>
